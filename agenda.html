<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda</title>
</head>
<body>
    <input type="button" id="answerCall" value="Answer Call"></input>
    <p id="getResults"></p>
    <p id="postResults"></p>

    <script src="js/signal.js" async></script>
    <script>
        
        const url = 'https://script.google.com/macros/s/AKfycbwbVCo1_AozKouHDSbHeYMaxx_Azy63-UmJpyxGi3oGmFwCatd-6SEwkZtDgQ-KV0J4qw/exec'

        document.getElementById("answerCall").addEventListener("click", answerCall)
        let dataChannelDataReceived;
        let peerConnection;
        let sendChannel;
        let receiveChannel;
        const dataChannelOptions = {ordered: true};
        let dataChannelCounter = 0;
        let sendDataLoop;
        let answer;
        let callerOffer

        async function answerCall() {
            console.log("Answering call")
            const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]}
            peerConnection = new RTCPeerConnection(configuration);
            console.log('Created remote peer connection object peerConnection');
            peerConnection.onicecandidate = e => onIceCandidate(e);
            peerConnection.onicegatheringstatechange = e => onGatheringChange(e);
            
            peerConnection.ondatachannel = receiveChannelCallback;

            callerOffer = await getData(`${url}?step=2`);
            callerOffer = JSON.parse(callerOffer)
            console.log(callerOffer)

            if (callerOffer) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(callerOffer));
                answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                //postData(answer,`${url}?step=3`);
            }
        }
                
        async function onIceCandidate(event) {
            try {
                console.log('ice candidate', event)
                    console.log('ice gathering', peerConnection.iceGatheringState)
                    console.log('pc value', peerConnection)
                // eslint-disable-next-line no-unused-vars
                const ignore = await peerConnection.addIceCandidate(event.candidate);
                onAddIceCandidateSuccess();
            } catch (e) {
                onAddIceCandidateError(e);
            }

            console.log(`${peerConnection} ICE candidate:\n${event.candidate ? event.candidate.candidate : '(null)'}`);
        }

        function onAddIceCandidateSuccess() {
            console.log('AddIceCandidate success.');
        }
        
        function onGatheringChange(e){
            console.log("gather change", peerConnection.iceGatheringState)
            if(peerConnection.iceGatheringState === 'complete'){
                resetAnswer();
            }
        }

        async function resetAnswer(){
            console.log("reset Answer 1")
            peerConnection.setRemoteDescription(new RTCSessionDescription(callerOffer));
            answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log(answer)
            postData(answer,`${url}?step=3`);
        }

        function onAddIceCandidateError(error) {
            console.log(`Failed to add Ice Candidate: ${error.toString()}`);
        }

        function receiveChannelCallback(event) {
            console.log('Receive Channel Callback');
            receiveChannel = event.channel;
            receiveChannel.onmessage = onReceiveMessageCallback;
            receiveChannel.onopen = onReceiveChannelStateChange;
            receiveChannel.onclose = onReceiveChannelStateChange;
        }
        
        function onReceiveMessageCallback(event) {
            dataChannelDataReceived = event.data;
            document.getElementById("postResults").innerText = dataChannelDataReceived;
            console.log(`DataChannel receive counter: ${dataChannelDataReceived}`);
        }

        function onReceiveChannelStateChange() {
            const readyState = receiveChannel.readyState;
            console.log(`Receive channel state is: ${readyState}`);
        }
    </script>
</body>
</html>